generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  STUDENT
  COMPANY
  ADMIN
}

enum SwipeDirection {
  LEFT
  RIGHT
  SUPER
}

enum MatchStatus {
  ACTIVE
  ARCHIVED
  BLOCKED
}

enum ApplicationStatus {
  PENDING
  VIEWED
  SHORTLISTED
  INTERVIEW_SCHEDULED
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  SYSTEM
}

// ============================================
// AUTH & USERS
// ============================================

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  role         UserRole
  isVerified   Boolean   @default(false)
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  lastLoginAt  DateTime?

  studentProfile StudentProfile?
  companyProfile CompanyProfile?
  refreshTokens  RefreshToken[]
  sentMessages   Message[]       @relation("SentMessages")

  @@map("users")
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

// ============================================
// STUDENT
// ============================================

model StudentProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  firstName   String
  lastName    String
  dateOfBirth DateTime
  canton      String
  city        String
  bio         String?  @db.Text
  profilePhoto String?

  // Extended profile fields
  motivationVideoUrl  String?
  motivationLetter    String?  @db.Text
  profileCompleteness Int      @default(0)
  phone               String?
  nationality         String?

  // OCEAN personality scores (0.0 - 1.0)
  oceanOpenness          Float @default(0.5)
  oceanConscientiousness Float @default(0.5)
  oceanExtraversion      Float @default(0.5)
  oceanAgreeableness     Float @default(0.5)
  oceanNeuroticism       Float @default(0.5)

  // RIASEC career interest scores (0.0 - 1.0)
  riasecRealistic     Float @default(0)
  riasecInvestigative Float @default(0)
  riasecArtistic      Float @default(0)
  riasecSocial        Float @default(0)
  riasecEnterprising  Float @default(0)
  riasecConventional  Float @default(0)

  quizCompletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  desiredFields StudentDesiredField[]
  swipes        Swipe[]
  matches       Match[]
  applications  Application[]
  schools       StudentSchool[]
  skills        StudentSkill[]
  languages     StudentLanguage[]
  schnupperlehren SchnupperlehreEntry[]

  @@map("student_profiles")
}

model StudentDesiredField {
  id        String @id @default(cuid())
  studentId String
  field     String
  priority  Int    @default(0)

  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, field])
  @@map("student_desired_fields")
}

// ============================================
// COMPANY
// ============================================

model CompanyProfile {
  id                String  @id @default(cuid())
  userId            String  @unique
  companyName       String
  description       String  @db.Text
  industry          String
  companySize       String
  website           String?
  logoUrl           String?
  videoUrl          String?
  canton            String
  city              String
  address           String?
  contactPersonName String
  contactPersonRole String?
  isVerified        Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  listings Listing[]
  photos   CompanyPhoto[]
  links    CompanyLink[]

  @@map("company_profiles")
}

model CompanyPhoto {
  id        String   @id @default(cuid())
  companyId String
  url       String
  caption   String?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  company CompanyProfile @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("company_photos")
}

model CompanyLink {
  id        String   @id @default(cuid())
  companyId String
  label     String
  url       String
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())

  company CompanyProfile @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@map("company_links")
}

// ============================================
// LISTINGS
// ============================================

model Listing {
  id          String @id @default(cuid())
  companyId   String
  title       String
  description String @db.Text
  field       String
  berufsfeld  String @default("")

  requiredSchoolLevel String?
  requiredLanguages   String[]  @default(["de"])
  startDate           DateTime?
  durationYears       Int       @default(3)
  spotsAvailable      Int       @default(1)

  // Ideal personality fit (set by company, optional)
  idealOceanOpenness          Float?
  idealOceanConscientiousness Float?
  idealOceanExtraversion      Float?
  idealOceanAgreeableness     Float?
  idealOceanNeuroticism       Float?
  idealRiasecRealistic        Float?
  idealRiasecInvestigative    Float?
  idealRiasecArtistic         Float?
  idealRiasecSocial           Float?
  idealRiasecEnterprising     Float?
  idealRiasecConventional     Float?

  canton   String
  city     String
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company      CompanyProfile @relation(fields: [companyId], references: [id], onDelete: Cascade)
  swipes       Swipe[]
  matches      Match[]
  applications Application[]

  @@index([companyId])
  @@index([field])
  @@index([canton])
  @@index([isActive])
  @@map("listings")
}

// ============================================
// SWIPES & MATCHING
// ============================================

model Swipe {
  id        String         @id @default(cuid())
  studentId String
  listingId String
  direction SwipeDirection
  createdAt DateTime       @default(now())

  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  listing Listing        @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([studentId, listingId])
  @@index([studentId])
  @@index([listingId])
  @@map("swipes")
}

model Match {
  id                 String      @id @default(cuid())
  studentId          String
  listingId          String
  compatibilityScore Float
  status             MatchStatus @default(ACTIVE)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  student     StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  listing     Listing        @relation(fields: [listingId], references: [id], onDelete: Cascade)
  messages    Message[]
  application Application?

  @@unique([studentId, listingId])
  @@index([studentId])
  @@index([listingId])
  @@map("matches")
}

// ============================================
// MESSAGING
// ============================================

model Message {
  id        String      @id @default(cuid())
  matchId   String
  senderId  String
  content   String      @db.Text
  type      MessageType @default(TEXT)
  isRead    Boolean     @default(false)
  createdAt DateTime    @default(now())

  match  Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  sender User  @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([matchId])
  @@index([senderId])
  @@map("messages")
}

// ============================================
// APPLICATIONS
// ============================================

model Application {
  id        String            @id @default(cuid())
  studentId String
  listingId String
  matchId   String            @unique
  status    ApplicationStatus @default(PENDING)
  notes     String?           @db.Text
  timeline  Json              @default("[]")
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  student StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  listing Listing        @relation(fields: [listingId], references: [id], onDelete: Cascade)
  match   Match          @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@unique([studentId, listingId])
  @@index([studentId])
  @@index([listingId])
  @@map("applications")
}

// ============================================
// STUDENT EXTENDED PROFILE
// ============================================

model StudentSchool {
  id        String   @id @default(cuid())
  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  name      String
  level     String?
  startYear Int?
  endYear   Int?
  isCurrent Boolean  @default(false)

  @@index([studentId])
  @@map("student_schools")
}

model StudentSkill {
  id        String   @id @default(cuid())
  studentId String
  student   StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  name      String

  @@index([studentId])
  @@map("student_skills")
}

model StudentLanguage {
  id          String   @id @default(cuid())
  studentId   String
  student     StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  language    String
  proficiency String

  @@index([studentId])
  @@map("student_languages")
}

model SchnupperlehreEntry {
  id          String   @id @default(cuid())
  studentId   String
  student     StudentProfile @relation(fields: [studentId], references: [id], onDelete: Cascade)
  companyName String
  beruf       String?
  canton      String?
  date        DateTime?
  notes       String?  @db.Text

  @@index([studentId])
  @@map("schnupperlehre_entries")
}

// ============================================
// BERUFE (CAREER MATCHING)
// ============================================

model Beruf {
  id            String  @id @default(cuid())
  name          String
  field         String
  educationType String
  description   String? @db.Text

  // RIASEC fit profile (0.0 - 1.0 each)
  riasecR Float @default(0)
  riasecI Float @default(0)
  riasecA Float @default(0)
  riasecS Float @default(0)
  riasecE Float @default(0)
  riasecC Float @default(0)

  @@map("berufe")
}
